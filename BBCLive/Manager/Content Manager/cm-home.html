<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./../../Manager/Content Manager/cmstyles/css/cm-home.css">
  <link href="https://vjs.zencdn.net/8.6.1/video-js.css" rel="stylesheet">
  <script src="https://vjs.zencdn.net/7.15.4/video.js"></script>
  <title>HOME</title>
</head>

<body>
  <header class="top-nav">
    <div class="header-container">
      <nav>
        <div class="header-logo">
          <img src="../../res/slu-logo.png" alt="slu-Logo">
        </div>

        <ul>
          <li><a href="cm-home.html">Home</a></li>
          <li><a href="#" onclick="goToResources();">Resources</a></li>
          <li><a href="#" onclick="goToLogs()">Logs</a></li>
        </ul>

        <div class="header-profile">
          <!-- <img src="pathofdadp" alt="user-dp"> -->
          <div id="cmDetails" class="cmDets">
            <!-- Content manager avatar and name will be displayed here -->
          </div>
          <div class="line"></div>
          <div class="user-info">
            <a href="">Username</a>
            <button id="logoutBtn" onclick="logout()">Logout</button>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <section>
    <h1>Home</h1>
    <div class="container" id="dashboard">
      <video id="my-video" class="video-js vjs-default-skin" controls width="640" height="360">
      </video>

    </div>
    <div class="container" id="webcamContainer">
    </div>
    <button onclick="toggleMedia()">Toggle Live</button>

    <div class="scheduleContainer">
      <h1>Schedules</h1>
      <div id="scheduleButtons">

      </div>
    </div>
  </section>
  <script>
    fetch('/getUserSchedules')
      .then(response => response.json())
      .then(schedules => {
        console.log(schedules)
        const currentDate = new Date(); // Get the current date
        const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        const currentDayIndex = new Date().getDay();

        // Generate buttons for the next 7 days based on the user's schedule
        const scheduleButtonsContainer = document.getElementById('scheduleButtons');
        for (let i = 0; i < 7; i++) {
          const nextDate = new Date();
          nextDate.setDate(nextDate.getDate() + (i - currentDayIndex + 7) % 7); // Calculate the next date

          // Find the next occurrence of a scheduled day
          const nextScheduledDay = schedules.find(schedule =>
            schedule.day === daysOfWeek[nextDate.getDay()]
          );

          if (nextScheduledDay) {
            const button = document.createElement('button');
            button.textContent = `${nextScheduledDay.day} - ${nextDate.toDateString()}`;
            button.setAttribute('class', 'sched');
            button.addEventListener('click', () => {
              const chosenDate = `${nextScheduledDay.day} - ${nextDate.toDateString()}`;
              goToEditor(chosenDate);
              console.log(`Button clicked for ${chosenDate}`);
            });

            scheduleButtonsContainer.appendChild(button);
          }
        }
      })
      .catch(error => console.error('Error fetching schedules:', error));
   
      // Function to fetch and display content manager details
    function displayCmDetails() {
      // Make an AJAX request to the endpoint that provides content manager details
      fetch('/getCmDetails')
        .then(response => response.json())
        .then(cmDetails => {
          // Update the HTML with content manager details
          const cmDetailsDiv = document.getElementById('cmDetails');
          cmDetailsDiv.innerHTML = `
                <div class="avatar-container">
                    <img src="./../../${cmDetails.dp}" class="avatar" alt="Avatar">
                </div>
            
            `;
          const usernameLink = document.querySelector('.user-info a');
          usernameLink.textContent = cmDetails.username;
        })
        .catch(error => {
          console.error('Error fetching content manager details:', error);
        });
    }

    // Call the function to display content manager details on page load
    displayCmDetails();

    // Function to handle redirect to resources.html
    function goToResources() {
      // Make an AJAX request to the server to handle the redirection
      fetch('/gotoresources')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Redirect to resources.html after successful request
            window.location.href = '/Manager/Content%20Manager/resources.html';
          } else {
            alert('Failed to go to Resources');
          }
        })
        .catch(error => {
          console.error('Error during request to go to Resources:', error);
        });
    }

    function goToLogs() {
      // Make an AJAX request to the server to handle the redirection
      fetch('/gotoLogs')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Redirect to resources.html after successful request
            window.location.href = '/Manager/Content%20Manager/cm-logs.html';
          } else {
            alert('Failed to go to Logs');
          }
        })
        .catch(error => {
          console.error('Error during request to go to Logs:', error);
        });
    }

    function goToEditor(chosenDate) {
      // Make an AJAX request to the server to handle the redirection
      fetch(`/gotoeditor`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Redirect to cm-editor.html after a successful request
            window.location.href = `/Manager/Content%20Manager/cm-editor.html?chosenDate=${encodeURIComponent(chosenDate)}`;
          } else {
            alert('Failed to go to Editor');
          }
        })
        .catch(error => {
          console.error('Error during request to go to Editor:', error);
        });
    }

    // Function to handle logout
    function logout() {
      // Make an AJAX request to the logout endpoint
      fetch('/logout')
        .then(response => response.json())
        .then(data => {
          console.log('Logout response:', data);
          if (data.success) {
            alert('Logout successful');
            window.location.href = '/'
          } else {
            alert('Logout failed');
          }
        })
        .catch(error => {
          console.error('Error during logout:', error);
        });
    }

    function checkForVideo() {
      fetch('/fetchVideo')
        .then((response) => response.json())
        .then((data) => {
          const videos = data.videos;

          if (videos && videos.length > 0) {
            const video = videos[0];
            const player = videojs('my-video');
            console.log(video);

            // Check if the video is not already playing
            if (player.paused()) {
              // Change the source and play the video
              player.src({ src: `./../..${video.filepath}`, type: 'video/mp4' });
              player.load();
              player.play();
            }
          }
        })
        .catch((error) => {
          console.error('Error fetching video:', error);
        });
    }
    setInterval(checkForVideo, 1000);

    let isPlaying = true;
    let mediaRecord;

    async function toggleMedia() {
      const videoContainer = document.getElementById('dashboard');
      const webcamContainer = document.getElementById('webcamContainer');
      const webcamVideo = document.getElementById('webcamVid');
      // const webcamPlayer = videojs('webcamVid');
      const player = videojs('my-video')

      if (isPlaying) {

        // toggleBtn.textContent = 'start webcam';
        player.pause();
        videoContainer.style.display = 'none';
        webcamContainer.style.display = 'block';

        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });

          const webcamVideo = document.createElement('video');
          webcamVideo.id = 'webcamVid';
          webcamVideo.className = 'video-js';
          webcamVideo.height = '500px';
          webcamVideo.width = '900px';
          webcamVideo.controls = true;
          webcamVideo.srcObject = stream;

          webcamContainer.innerHTML = '';
          webcamContainer.appendChild(webcamVideo);
          console.log(stream);
          // mediaRecord = new MediaRecorder(stream);

          webcamVideo.play();
          console.log(stream);
        } catch (error) {
          console.error('Error accessing webcam', error);
        }
      } else {
        const webcamVideo2 = document.getElementById('webcamVid');
        if (webcamVideo2) {
          const webcamStream = webcamVideo2.srcObject;
          if (webcamStream) {
            const tracks = webcamStream.getTracks();
            tracks.forEach(track => track.stop());
          };
          webcamVideo2.srcObject = null;
        }
        videoContainer.style.display = 'block';
        webcamContainer.style.display = 'none';

        const player = videojs('my-video');
        player.play();
      }

      isPlaying = !isPlaying;
    }

  </script>
</body>

</html>