<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./../../Manager/Content Manager/cmstyles/css/cm-editor.css">
  <link href="https://vjs.zencdn.net/8.6.1/video-js.css" rel="stylesheet">
  <script src="https://vjs.zencdn.net/7.15.4/video.js"></script>
  <title>HOME</title>
</head>

<body>
  <header class="top-nav">
    <div class="header-container">
      <nav>
        <div class="header-logo">
          <a href=".">
            <img src="../../res/slu-logo.png" alt="slu-Logo">
          </a>
        </div>

        <ul>
          <li><a href="cm-home.html">Home</a></li>
          <li><button onclick="goToResources()" id="btn">Resources</button></li>
          <li><a href="cm-logs.html">Logs</a></li>
        </ul>

        <div class="header-profile">
          <div id="cmDetails" class="cmDets">
          </div>
          <div class="line"></div>
          <div class="user-info">
            <a href="">Username</a>
            <button id="logoutBtn" onclick="logout()">Logout</button>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <body>
    <video id='my-video' class='video-js' preload='auto' height='500' width='900' controls
      poster='./../../res/bbc-logo.png' data-setup='{}'>

      <p>
        <a href='https://videojs.com/html5-video-support/' target='_blank'>supports HTML5 video</a>
      </p>
    </video>

    <div class="container" id="tablesContainer">
      <table>
        <thead>
          <tr>
            <th>Resources</th>
            <th>File Type</th>
          </tr>
        </thead>
        <tbody id="resourcesContainer">
          <tr draggable="true" class="video-row">
            <td >Looks like you dont have any content yet!</td>
            <td>file type</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div id="dateTimeContainer">
      <p>Happy <span id="dayOfWeek"></span>! Today is: <span id="dateFromServer"></span>. It's currently <span
          id="timeFromServer"></span> </p>
    </div>

    <div class="container" id="sceneContainer" ondragover="dragOver(event)" ondrop="drop(event)">
      <table>
        <thead>
          <tr>
            <th>Scenes</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Your Scene Data</td>
          </tr>
        </tbody>
      </table>
    </div>

    <script>
      function fetchVideo() {
        fetch('/editorFetch')
          .then(response => response.json())
          .then(data => {
            const filepath = data.filepath;
            const player = videojs('my-video');
            player.src({ src: filepath, type: 'video/mp4' });
            // Automatically play the video
            player.play();
          });
      }

      function dragStart(event) {
        event.dataTransfer.setData("text/plain", event.target.textContent);
      }

      function dragOver(event) {
        event.preventDefault();
      }

      function drop(event) {
        event.preventDefault();
        const data = event.dataTransfer.getData("text/plain");

        const newCell = document.createElement("td");
        const newRow = document.createElement("tr");
        newCell.textContent = data;
        newRow.appendChild(newCell);

        const sceneContainer = document.getElementById("sceneContainer").getElementsByTagName("table")[0];
        sceneContainer.appendChild(newRow);
      }

      function fetchResources() {
        fetch('/editor')
          .then(response => response.json())
          .then(data => {
            updateResourceTable(data);
          })
          .catch(error => {
            console.error('Fetch error:', error);
          });
      }

      function updateResourceTable(data) {
        const resourceTableBody = document.getElementById('resourcesContainer');
        resourceTableBody.innerHTML = '';

        data.forEach(resource => {
          const row = document.createElement('tr');
          row.innerHTML = `<td class="video-row" draggable="true">${resource.filename}</td><td draggable="false">${resource.type}</td>`;
          row.draggable = true;
          row.addEventListener('dragstart', dragStart);

          // Add click event listener to each row
          row.addEventListener('click', () => playVideo(resource.filepath, row));

          resourceTableBody.appendChild(row);
        });
      }

      function playVideo(filepath, clickedRow) {
  const player = videojs('my-video');
  console.log(filepath);
  player.src({ src: filepath, type: 'video/mp4' });
  // Automatically play the video
  player.play();

  // Remove the 'selected-row' class from the previously highlighted row
  const previouslySelectedRow = document.querySelector('.video-row.selected-row');
  if (previouslySelectedRow) {
    previouslySelectedRow.classList.remove('selected-row');
  }

  // Add the 'selected-row' class to the clicked row
  clickedRow.classList.add('selected-row');
}


      // Initial fetch of resources when the page loads
      fetchResources();

      // Function to handle logout
      function logout() {
        fetch('/logout')
          .then(response => response.json())
          .then(data => {
            console.log('Logout response:', data);
            if (data.success) {
              alert('Logout successful');
              window.location.href = '/';
            } else {
              alert('Logout failed');
            }
          })
          .catch(error => {
            console.error('Error during logout:', error);
          });
      }

      // Function to fetch and display content manager details
      function displayCmDetails() {
        // Make an AJAX request to the endpoint that provides content manager details
        fetch('/getCmDetails')
          .then(response => response.json())
          .then(cmDetails => {
            // Update the HTML with content manager details
            const cmDetailsDiv = document.getElementById('cmDetails');
            cmDetailsDiv.innerHTML = `
                  <div class="avatar-container">
                      <img src="./../../${cmDetails.dp}" class="avatar" alt="Avatar">
                  </div>
              
              `;
            const usernameLink = document.querySelector('.user-info a');
            usernameLink.textContent = cmDetails.username;
          })
          .catch(error => {
            console.error('Error fetching content manager details:', error);
          });
      }

      function fetchDateTime() {
        fetch('/getDateTime')
          .then(response => response.json())
          .then(data => {
            console.log('Received data:', data); // Log the received data to the console
            const dayOfWeekElement = document.getElementById('dayOfWeek');
            const dateElement = document.getElementById('dateFromServer');
            const timeElement = document.getElementById('timeFromServer');

            dayOfWeekElement.textContent = data.dayOfWeek;
            dateElement.textContent = data.date;
            timeElement.textContent = data.time;
          })
          .catch(error => {
            console.error('Error fetching date and time:', error);
          });
      }

      document.addEventListener('DOMContentLoaded', function () {
        // Attach click event listeners to all video rows in the resource table
        const videoRows = document.querySelectorAll('#resourcesContainer .video-row');
        videoRows.forEach(row => {
          row.addEventListener('click', function () {
            // Get the filepath from the clicked row
            const filepath = row.dataset.filepath; // Assuming you have the filepath in a data attribute

            // Call the playVideo function with the filepath and the clicked row
            playVideo(filepath, row);
          });
        });
      });


      // Call the function to display content manager details on page load
      displayCmDetails();


      // Fetch and display date and time when the page loads
      fetchDateTime();

      // Fetch and update date and time every 1 minute (adjust as needed)
      setInterval(fetchDateTime, 60000);
    </script>

  </body>